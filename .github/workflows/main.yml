name: SBOM Generation & Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Gerar SBOM semanalmente
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  security-events: write
  actions: read

jobs:
  generate-sbom-python:
    name: Generate Python SBOM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Generate SBOM com Syft (SPDX e CycloneDX)
        run: |
          # Atualizado de 'packages' para 'scan' (sintaxe nova do Syft)
          syft scan dir:. -o spdx-json=sbom-python-spdx.json
          syft scan dir:. -o cyclonedx-json=sbom-python-cyclonedx.json
      
      - name: Generate SBOM com CycloneDX Python
        run: |
          pip install cyclonedx-bom
          # Garante que o requirements.txt existe antes de rodar
          if [ -f requirements.txt ]; then
            cyclonedx-py requirements requirements.txt -o sbom-python-cdx.json
          else
            echo "requirements.txt nÃ£o encontrado, pulando CycloneDX Python"
          fi
      
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-sboms
          path: sbom-python-*.json
          retention-days: 90
      
      - name: Commit SBOM to repository
        # Importante: O token padrÃ£o pode nÃ£o ter permissÃ£o em branches protegidas (main)
        run: |
          mkdir -p sbom
          mv sbom-python-*.json sbom/
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sbom/
          # Verifica se hÃ¡ mudanÃ§as antes de commitar para evitar erro
          if ! git diff --quiet --cached; then
            git commit -m "chore: update Python SBOM [skip ci]"
            git push
          else
            echo "No changes to push"
          fi
        continue-on-error: true

  analyze-licenses:
    name: License Analysis
    needs: [generate-sbom-python]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Download SBOM artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-sboms
          path: . # Baixa na raiz para facilitar os scripts abaixo
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install pip-licenses e dependÃªncias
        run: |
          pip install -r requirements.txt
          pip install pip-licenses
      
      - name: Generate License Report
        run: |
          pip-licenses --format=json --output-file=licenses.json
          pip-licenses --format=markdown --output-file=licenses.md
          pip-licenses --format=csv --output-file=licenses.csv
      
      - name: Check for GPL licenses (exemplo de policy)
        run: |
          echo "ðŸ” Verificando licenÃ§as GPL..."
          if pip-licenses | grep -i "gpl"; then
            echo "âš ï¸  ATENÃ‡ÃƒO: DependÃªncias com licenÃ§a GPL detectadas!"
            echo "Revise a compatibilidade com a licenÃ§a do projeto"
            # Remover 'exit 1' se quiser apenas avisar e nÃ£o quebrar o build
          else
            echo "âœ… Nenhuma licenÃ§a GPL detectada"
          fi
        continue-on-error: true
      
      - name: Upload License Report
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: licenses.*
          retention-days: 90
      
      - name: Create License Summary
        run: |
          echo "# ðŸ“„ RelatÃ³rio de LicenÃ§as" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat licenses.md >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  vulnerability-scan-sbom:
    name: Scan SBOM for Vulnerabilities
    needs: [generate-sbom-python]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: python-sboms
          path: . # Baixa na raiz para o Grype encontrar o arquivo
      
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Scan SBOM com Grype
        run: |
          # O grype precisa encontrar o arquivo baixado no path correto
          grype sbom:sbom-python-spdx.json -o json --file grype-sbom-results.json
          grype sbom:sbom-python-spdx.json -o table > grype-sbom-results.txt
          cat grype-sbom-results.txt # Mostra no log do console tambÃ©m
        continue-on-error: true
      
      - name: Upload Vulnerability Report
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-reports
          path: |
            grype-sbom-results.json
            grype-sbom-results.txt
          retention-days: 90

  dependency-tree:
    name: Generate Dependency Tree
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install pipdeptree e dependÃªncias
        run: |
          # CORREÃ‡ÃƒO PRINCIPAL: Adicionado '-r' antes do requirements.txt
          pip install -r requirements.txt
          pip install pipdeptree
      
      - name: Generate Dependency Tree
        run: |
          pipdeptree --json > dependency-tree.json
          pipdeptree > dependency-tree.txt
      
      - name: Upload Dependency Tree
        uses: actions/upload-artifact@v4
        with:
          name: dependency-tree
          path: dependency-tree.*
          retention-days: 30

  sbom-summary:
    name: SBOM Summary Report
    needs: [generate-sbom-python, analyze-licenses, vulnerability-scan-sbom]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        # NÃ£o especificamos 'name', entÃ£o ele baixarÃ¡ todos em subpastas
      
      - name: Create comprehensive summary
        run: |
          echo "# ðŸ“¦ Software Bill of Materials (SBOM)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Status dos Jobs" >> $GITHUB_STEP_SUMMARY
          echo "- Python SBOM: ${{ needs.generate-sbom-python.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- License Analysis: ${{ needs.analyze-licenses.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerability Scan: ${{ needs.vulnerability-scan-sbom.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Formatos Gerados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SPDX JSON" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CycloneDX JSON" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… License Report (JSON, MD, CSV)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency Tree" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Artefatos" >> $GITHUB_STEP_SUMMARY
          echo "Todos os SBOMs e relatÃ³rios estÃ£o disponÃ­veis como artifacts desta execuÃ§Ã£o." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Gerado em: $(date)" >> $GITHUB_STEP_SUMMARY
